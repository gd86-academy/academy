<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
   
    
</head>
<body>
    <div id="username-page"> 
        <h1>Enter your username</h1>
        <form id="usernameForm">
            <input type="text" id="name" placeholder="Username" required>
            <button type="submit">Join Chat</button>
        </form>
    </div>
    <div th:if="${error}" class="error-message">
    <p th:text="${error}"></p>
</div>

    <div id="chat-page" class="hidden"> 
        <h2 th:text="${room.roomName}"></h2>
        <div id="chat-messages"></div>
        <form id="messageForm"> 
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off"> 
            <button type="submit">Send</button>
        </form>
    </div>
    
    <button onclick="leaveRoom()">Leave Room</button>
    <button onclick="deleteRoom()">Delete Room</button>
    <a th:href="@{/chat/modifyRoom(roomId=${room.roomId})}" class="btn">Modify Room</a>
    
    
    
</body>

 <script th:inline="javascript"> 
    var roomId = '[[${room.roomId}]]';  // 사용자가 접속할 특정 채팅방의 ID를 저장
        var username = null; // 사용자가 입력한 이름을 저장할 변수
        var stompClient = null; // STOMP 클라이언트를 저장하여 채팅방과의 실시간 연결을 관리

        function connect(event) { // 사용자가 채팅방에 접속하려고 할 때 호출됨, 채팅방에 접속하는 동작을 수행하는 함수
            username = document.querySelector('#name').value.trim(); // #name이라는ID를 가진 HTML에서 사용자가 입력한 이름을 가져옴
            if (username) { // 사용자 이름을 입력시
                $.ajax({
                    url: 'http://localhost/academy/chat/join', // 이 경로로 post요청을 보냄, 사용자의 채팅방 입장 요청을 처리할 URL
                    type: 'POST',
                    data: { roomId: roomId, username: username }, // 채팅방에 추가
                    dataType: 'json',
                    success: function(response) { // 서버에서 채팅방 입장 성공 후의 처리를 담당하는 부분
                        if (response.error) { // 서버에서 입장 실패 메시지를 받았을 때 이를 처리
                            alert(response.error); // 채팅방 입장 실패시 사용자에게 오류 메시지를 보여줌
                        } else {
                            var socket = new SockJS('/ws-stomp'); // 서버와 실시간 연결을 생성하기 위해 SockJS를 사용
                            stompClient = Stomp.over(socket); // 실시간 메시지를 주고받을 수 있도록 하는 클라이언트를 생성
                            stompClient.connect({}, onConnected, onError);
                        }
                    },
                    error: function(xhr, status, error) { // AJAX 요청이 실패할 경우 사용자에게 오류 메시지를 보여준다.
                        alert("입장 실패: " + xhr.responseText); // 입장 실패 오류 메시지
                    }
                });
            }
            event.preventDefault();
        }

        function onConnected() { // 사용자가 성공적으로 채팅방에 접속한 후 실행되는 함수
            stompClient.subscribe('/sub/chat/room/' + roomId, onMessageReceived); // STOMP 클라이언트를 사용하여 서버의 특정 주제에 구독을 신청하는 메서드
            // /sub/chat/room/' + roomId : 서버에서 메시지를 받을 채팅방에 대한 구독 경로
            // onMessageReceived는 메시지가 수진될 때마다 호출되는 콜백함수. 새로운 메시지를 화면에 표시하는 등의 역할을 한다.
            stompClient.send("/pub/chat/enterUser", {}, JSON.stringify({roomId: roomId, sender: username, type: 'ENTER'}));
            // /pub/chat/enterUser : 사용자가 채팅방에 입장할 때 서버로 보내는 메시지의 경로
            // 사용자가 채팅방에 입장했음을 서버에 알리고, 해당 채팅방의 사용자 목록을 갱신하거나 다른 로직을 처리하도록 요청한다.
            
            $.get('/chat/history', { roomId: roomId }, function(data) { // 채팅방의 이전 메시지 기록을 서버에서 받아오기 위한 요청을 보냄
                data.forEach(function(message) { // 서버에서 받은 채팅 메시지들을 하나씩 처리하기 위한 반복문
                    displayMessage(message); // 이전 채팅 메시지를 화면에 출력하는 함수
                });
            }); 

            document.querySelector('#username-page').classList.add('hidden'); // 사용자의 이름을 입력하는 페이지 요소. 이름 입력 페이지를 숨김
            // 채팅방에 입장한 후, 사용자 이름 입력 페이지를 숨김
            document.querySelector('#chat-page').classList.remove('hidden'); // 실제 채팅을 진행할 페이지 요소를 선택함. 
            // 채팅방 입장 후, 채팅 페이지를 화면에 표시한다.
        }

        function displayMessage(message) { // 채팅 메시지를 HTML요소로 변환하여 화면에 표시하는 함수
            var messageElement = document.createElement('div'); // div 요소를 생성
            messageElement.classList.add('chat-message'); // 생성된 메시지 요소에 스타일을 적용하기 위해 chat-message클래스를 추가

            var usernameElement = document.createElement('span');
            var usernameText = document.createTextNode(message.employeeName); //메시지에 대한 발신자의 이름을 텍스트 노드로 생성
            usernameElement.appendChild(usernameText); // usernameText을 추가

            var textElement = document.createElement('p');
            var messageText = document.createTextNode(message.messageContent); // 메시지 내용을 텍스트 노드로 생성
            textElement.appendChild(messageText);

            var timeElement = document.createElement('span');
            timeElement.classList.add('message-time'); // 메시지의 시간 정보를 스타일링하기 위해 message-time 클래스를 추가
            timeElement.textContent = new Date(message.createdAt).toLocaleString(); // 메시지가 생성된 시간을 timeElement에 표시한다.

            messageElement.appendChild(usernameElement); // 메시지 컨테이너에 사용자 이름을 추가
            messageElement.appendChild(textElement); // 메시지 컨테이너에 메시지 내용을 추가
            messageElement.appendChild(timeElement); // 메시지 컨테이너에 메시지 시간 정보를 추가

            document.querySelector('#chat-messages').appendChild(messageElement); // #chat-messages 요소에 새 메시지 요소를 추가하여 사용자에게 메시지를 화면에 표시
        }

        function onError(error) { 
            console.log('Could not connect to WebSocket server. Please refresh this page to try again!');
        }

        function sendMessage(event) { // 사용자가 입력한 메시지를 서버로 전송하는 역할
            var messageContent = document.querySelector('#message').value.trim(); // id="message"인 HTML 요소를 선택. 이 요소는 사용자가 채팅 메시지를 입력하는 입력 필드
            if (messageContent && stompClient) { // 메시지가 비어 있지 않고, stompClient 객체가 초기화되어 있다면 메시지를 전송
                var chatMessage = { // 서버로 보낼 메시지 객체를 생성
                    roomId: roomId,
                    sender: username,
                    message: messageContent,
                    type: 'TALK'
                }; 
                stompClient.send("/pub/chat/sendMessage", {}, JSON.stringify(chatMessage)); // 생성한 chatMessage 객체를 서버로 전송
                document.querySelector('#message').value = ''; // 메시지를 전송한 후, 입력 필드를 비워서 사용자가 새로운 메시지를 입력할 수 있도록 한다.
            }
            event.preventDefault();
        }// 이 함수는 사용자가 채팅 메시지를 입력하고 "전송" 버튼을 클릭했을 때 실행됩니다. 입력된 메시지를 서버로 전송하고, 전송 후 입력 필드를 비우며, 기본 동작을 방지합니다.

        function onMessageReceived(payload) { // 채팅 메시지를 수신할 때 실행되는 함수로, 수신된 메시지를 화면에 표시하는 역할
            var message = JSON.parse(payload.body); // 수신한 메시지를 JS객체로 변환하여 사용 가능하게 만든다.
            var messageElement = document.createElement('div'); 
            if (message.type === 'ENTER') { // 사용자가 채팅방에 입장할 때 발생하는 메시지
                messageElement.classList.add('event-message');
                message.content = message.sender + ' joined!';
            } else if (message.type === 'LEAVE') { // 사용자가 채팅방을 나갈 때 발생하는 메시지
                messageElement.classList.add('event-message');
                message.content = message.sender + ' left!';
            } else { 
                messageElement.classList.add('chat-message'); // 그 외의 메시지는 사용자가 보내는 일반 채팅 메시지로 처리
                var usernameElement = document.createElement('span');
                var usernameText = document.createTextNode(message.sender); // 해당 발신자의 이름을 표시
                usernameElement.appendChild(usernameText);
                messageElement.appendChild(usernameElement);
            }
            var textElement = document.createElement('p'); 
            var messageText = document.createTextNode(message.message); // 수신된 실제 메시지 내용
            textElement.appendChild(messageText); // 
            messageElement.appendChild(textElement);
            document.querySelector('#chat-messages').appendChild(messageElement); // 수신된 메시지가 화면에 표시됨
        } // 이 함수는 WebSocket을 통해 수신된 메시지를 처리하고, 해당 메시지를 화면에 표시하는 역할을 합니다. 메시지가 입장/퇴장 메시지인지 일반 채팅 메시지인지를 구분하고, 그에 맞는 스타일로 표시합니다.

        document.querySelector('#usernameForm').addEventListener('submit', connect, true); // 사용자 이름을 입력하는 폼. submit 이벤트가 발생할 때 connect함수가 호출되도록 설정
        document.querySelector('#messageForm').addEventListener('submit', sendMessage, true); // 메시지 입력 폼. 
        
        function leaveRoom() { // 사용자가 채팅방을 떠날 때 호출되는 함수로, 채팅방을 나가는 과정에서 필요한 처리를 담당
            if (stompClient) {  // stompClient : 사용자가 채팅방에 접속 중일 때만 존재
                var chatMessage = {
                    roomId: roomId,
                    sender: username,
                    type: 'LEAVE'
                }; // 서버에 전송할 메시지를 준비
                stompClient.send("/pub/chat/leaveUser", {}, JSON.stringify(chatMessage)); // 서버에 사용자가 채팅방을 떠났다는 사실을 알리고, 채팅방에서 해당 사용자에 대한 처리가 이루어지도록 한다.
                stompClient.disconnect(); // 사용자가 채팅방을 떠날 때 WebSocket 연결을 종료하여, 더 이상 실시간 메시지를 처리하지 않게 합니다.
                window.location.href = "/"; // 사용자가 채팅방을 떠난 후 홈페이지로 이동
            }
        }

        function deleteRoom() { // 채팅방 삭제 시 호출되는 함수
            if (confirm("정말로 이 채팅방을 삭제하시겠습니까?")) { // confirm : 브라우저에서 확인 대화 상자를 띄우는 함수
                $.ajax({ // 서버에 채팅방을 삭제하는 요청을 보내는 기능을 수행
                    url: '/chat/leave', // 채팅방 삭제를 처리하는 서버의 URL을 지정
                    type: 'POST',
                    data: { roomId: roomId },
                    success: function(result) { // 팅방 삭제가 성공했을 때 사용자에게 성공 메시지를 표시하고, 페이지를 홈페이지로 이동시켜 채팅방을 삭제한 후의 상태를 반영
                        alert("채팅방이 성공적으로 삭제되었습니다.");
                        window.location.href = "/"; // 사용자가 채팅방을 떠난 후 홈페이지로 이동
                    },
                    error: function(xhr, status, error) {
                        alert("채팅방 삭제 중 오류가 발생했습니다: " + error);
                    }
                });
            }
        }        
    </script>
      
</html>
