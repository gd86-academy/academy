<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.academy.mapper.LectureApprovalMapper">

	<!--  진수우 : 강의결재 상세페이지에서 결재자 출력 -->
	<select id="selectLectureApprovalEmployee">
		SELECT 
			ae.approval_employee_no approvalEmployee
			, ae.lecture_approval_no lectureApprovalNo
			, e.employee_name approver
			, ae.approval_level approvalLevel
		FROM approval_employee ae
		LEFT OUTER JOIN employee e ON ae.approver = e.employee_no
		WHERE ae.lecture_approval_no = #{lectureApprovalNo}
	</select>

	<!-- 진수우 : 강의결재 상세페이지에서 파일 출력 -->
	<select id="selectLectureApprovalFile">
		SELECT
			f.file_no fileNo
			, f.file_name fileName
			, f.file_ext fileExt
			, f.file_origin fileOrigin
			, f.file_size fileSize
			, f.file_type fileType
			, f.file_category fileCategory
			, f.create_date createDate
			, f.update_date updateDate
		FROM file f
		LEFT OUTER JOIN lecture_approval_file laf ON f.file_no = laf.file_no
		LEFT OUTER JOIN lecture_approval la ON laf.lecture_approval_no = la.lecture_approval_no
		WHERE la.lecture_approval_no = #{lectureApprovalNo}
	</select>

	<!-- 진수우 : 강의결재 상세페이지에서 강의시간 출력 -->
	<select id="selectLectureApprovalWeekday">
		SELECT 
			lw.lecture_weekday_no lectureWeekdayNo
			, cw.name weekday
			, cb.name beginTime
			, ce.name endTime
		FROM lecture_weekday lw
		LEFT OUTER JOIN lecture_approval_lecture_weekday lalw ON lw.lecture_weekday_no = lalw.lecture_weekday_no
		LEFT OUTER JOIN lecture_approval la ON lalw.lecture_approval_no = la.lecture_approval_no
		LEFT OUTER JOIN common cb ON cb.code = lw.begin_time_code
		LEFT OUTER JOIN common ce ON ce.code = lw.end_time_code
		LEFT OUTER JOIN common cw ON cw.code = lw.weekday_code
		WHERE la.lecture_approval_no = #{lectureApprovalNo}
	</select>

	<!-- 진수우 : 강의결재 상세페이지에서 강의정보 출력 -->
	<select id="selectLectureApprovalOne">
		SELECT 
			la.lecture_approval_no lectureApprovalNo
			, e.employee_name employeeName
			, e.employee_no employeeNo
			, la.lecture_approval_title lectureApprovalTitle
			, la.lecture_approval_content lectureApprovalContent
			, la.lecture_name lectureName
			, la.lecture_content lectureContent
			, cl.classroom_name classroomName
			, la.lecture_begin_date lectureBeginDate
			, la.lecture_end_date lectureEndDate
			, c.name lectureApprovalStatus
			, la.lecture_approval_step lectureApprovalStep
			, la.create_date createDate
			, la.update_date updateDate
			, la.use_yn useYn
		FROM lecture_approval la
		LEFT OUTER JOIN classroom cl ON la.classroom_no = cl.classroom_no
		LEFT OUTER JOIN employee e ON la.lecturer = e.employee_no
		LEFT OUTER JOIN common c ON la.lecture_approval_status = c.code
		WHERE la.lecture_approval_no = #{lectureApprovalNo}
	</select>

	<!-- 진수우 : 강의결재신청 시 강의결재/파일 연결테이블에 해당정보 저장 -->
	<insert id="insertLectureApprovalFile">
		INSERT INTO lecture_approval_file (
			file_no
			, lecture_approval_no
		) VALUES (
			#{fileNo}
			, #{lectureApprovalNo}
		)
	</insert>

	<!-- 진수우 : 강의결재신청 시 결재자테이블에 해당정보 저장 -->
	<insert id="insertApprovalEmployee">
		INSERT INTO approval_employee (
			lecture_approval_no
			, approver
			, approval_level
		) VALUES (
			#{lectureApprovalNo}
			, #{approver}
			, #{approvalLevel}
		)
	</insert>
	
	<!-- 진수우 : 강의결재신청 시 강의결재테이블에 해당정보 저장 -->
	<insert id="insertLectureApproval" useGeneratedKeys="true" keyProperty="lectureApprovalNo">
		INSERT INTO lecture_approval (
			lecturer
			, lecture_approval_title
			, lecture_approval_content
			, lecture_name
			, lecture_content
			, classroom_no
			, lecture_begin_date
			, lecture_end_date
			, lecture_approval_step
		) VALUES (
			#{lecturer}
			, #{lectureApprovalTitle}
			, #{lectureApprovalContent}
			, #{lectureName}
			, #{lectureContent}
			, #{classroomNo}
			, #{lectureBeginDate}
			, #{lectureEndDate}
			, #{lectureApprovalStep}
		)
	</insert>

	<!-- 진수우 : 강의결재신청 시 강의결재/강의시간 연결테이블에 해당정보 저장 -->
	<insert id="insertLectureApprovalLectureWeekday">
		INSERT INTO lecture_approval_lecture_weekday (
			lecture_approval_no
			, lecture_weekday_no
		) VALUES (
			#{lectureApprovalNo}
			, #{lectureWeekdayNo}
		)
	</insert>

	<!-- 진수우 : 강의결재신청 시 강의시간테이블에 해당정보 저장 -->
	<insert id="insertLectureWeekday" parameterType="com.example.academy.vo.LectureWeekday" useGeneratedKeys="true" keyProperty="lectureWeekdayNo">
		INSERT INTO lecture_weekday (
			weekday_code
			, begin_time_code
			, end_time_code
		) VALUES (
			#{weekdayCode}
			, #{beginTimeCode}
			, #{endTimeCode}
		)
	</insert>

	<!-- 진수우 : 시작시간 선택 시 가능한 시간만 출력 -->
	<select id="selectLectureApprovalGetBeginTime">
		SELECT c.code, c.name
		FROM common c
		WHERE c.refer1 NOT IN (
		    SELECT c_inner.refer1
		    FROM common c_inner
		    LEFT OUTER JOIN lecture_weekday lw ON c_inner.code BETWEEN lw.begin_time_code AND lw.end_time_code
		    LEFT OUTER JOIN common cb ON lw.begin_time_code = cb.code -- 시작 시간 참조
		    LEFT OUTER JOIN common ce ON lw.end_time_code = ce.code   -- 종료 시간 참조
		    LEFT OUTER JOIN lecture_lecture_weekday llw ON llw.lecture_weekday_no = lw.lecture_weekday_no
		    LEFT OUTER JOIN lecture l ON l.lecture_no = llw.lecture_no
		    WHERE c_inner.code LIKE 'TM%'
		      AND c_inner.refer1 BETWEEN cb.refer1 AND ce.refer1
		      AND lw.weekday_code = #{weekdayCode}
		      AND l.classroom_no = #{classroomNo}
		      AND (l.lecture_begin_date BETWEEN #{beginDate} AND #{endDate} OR l.lecture_end_date BETWEEN #{beginDate} AND #{endDate})
		      OR ((#{beginDate} BETWEEN l.lecture_begin_date AND l.lecture_end_date) AND (#{endDate} BETWEEN l.lecture_begin_date AND l.lecture_end_date))
		) AND c.code LIKE 'TM%'
	</select>

</mapper>